<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="OGimage.png">
    <title>Pixel Art Generator</title>
    <style>
        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
            max-width: 177.78vh;
            /* 16/9 aspect ratio constraint based on height */
            max-height: 56.25vw;
            /* 9/16 aspect ratio constraint based on width */
            margin: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 16/9;
        }

        canvas {
            image-rendering: pixelated;
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>

<body>
    <div id="container">
        <canvas id="canvas" width="192" height="108"></canvas>
    </div>
    <script>
        // CONFIGURATION: Replace this with your Google Cloud External IP
        // Example: const SERVER_URL = 'http://34.123.45.67:8080';
        const SERVER_URL = 'https://pixel.domctorcheems.com';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let animations = [];
        let currentIndex = 0;
        let requestID;

        async function fetchAnimations() {
            try {
                // Fetch from the remote server
                const response = await fetch(`${SERVER_URL}/api/animations?t=${Date.now()}`);
                const newAnimations = await response.json();

                if (newAnimations.length > 0) {
                    // Shuffle
                    for (let i = newAnimations.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newAnimations[i], newAnimations[j]] = [newAnimations[j], newAnimations[i]];
                    }

                    // Only force load if we had nothing before
                    const isFirstLoad = animations.length === 0;
                    animations = newAnimations;

                    if (isFirstLoad) {
                        loadAnimation(currentIndex);
                    }
                }
            } catch (error) {
                console.error('Error fetching animations:', error);
            }
        }

        function loadAnimation(index) {
            if (animations.length === 0) return;

            const animationFile = animations[index];

            // Fetch the JS file content from the remote server
            fetch(`${SERVER_URL}/gen/${animationFile}`)
                .then(res => res.text())
                .then(scriptContent => {
                    if (requestID) cancelAnimationFrame(requestID);

                    try {
                        const func = new Function('ctx', 'frame', scriptContent + '\nreturn draw;');
                        const drawFunc = func();

                        let frame = 0;
                        function loop() {
                            ctx.clearRect(0, 0, 192, 108);
                            try {
                                drawFunc(ctx, frame);
                            } catch (e) {
                                console.error("Animation error", e);
                            }
                            frame++;
                            requestID = requestAnimationFrame(loop);
                        }
                        loop();

                    } catch (e) {
                        console.error("Error parsing animation script", e);
                    }
                });
        }

        // Cycle every 20 seconds
        setInterval(() => {
            if (animations.length > 0) {
                currentIndex = (currentIndex + 1) % animations.length;
                loadAnimation(currentIndex);
            }
        }, 20000);

        // Refresh periodically (1 min)
        setInterval(fetchAnimations, 60000);

        // Initial load
        fetchAnimations();
    </script>
</body>

</html>